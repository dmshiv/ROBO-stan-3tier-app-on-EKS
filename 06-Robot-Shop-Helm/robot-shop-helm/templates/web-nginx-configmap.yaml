# =============================================================================
# WEB NGINX CONFIGMAP - Nginx Configuration for Web Frontend
# =============================================================================
# A ConfigMap stores configuration data as key-value pairs.
# Here, we store the Nginx config file that the Web pods will use.
#
# WHY USE A CONFIGMAP?
# --------------------
# Instead of baking config into the Docker image, we store it separately.
# Benefits:
# 1. Change config without rebuilding the image
# 2. Different configs for dev/staging/prod
# 3. Easier troubleshooting (just edit the ConfigMap)
#
# HOW NGINX WORKS HERE:
# ---------------------
# Nginx acts as TWO things:
# 1. STATIC FILE SERVER: Serves HTML, CSS, JS files for the website
# 2. REVERSE PROXY: Routes API calls to backend microservices
#
# URL ROUTING EXPLAINED:
# ----------------------
# User visits: http://shop.example.com/api/catalogue/products
# Nginx sees: /api/catalogue/...
# Nginx routes to: http://catalogue:8080/products
#
# This is called "reverse proxying" - Nginx hides the backend services!
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: web-nginx-config
  labels:
    service: web
# The "data" section contains the actual config file(s)
# Key = filename, Value = file contents
data:
  # This becomes /etc/nginx/conf.d/default.conf in the container
  default.conf: |
    # =======================================================================
    # INSTANA TRACING - Application Performance Monitoring
    # =======================================================================
    # These lines enable distributed tracing with Instana APM
    # You can see request flow across all microservices
    opentracing_load_tracer /usr/local/lib/libinstana_sensor.so /etc/instana-config.json;
    opentracing_propagate_context;

    # =======================================================================
    # MAIN SERVER CONFIGURATION
    # =======================================================================
    server {
        # Listen on port 8080 (matches containerPort in deployment)
        listen       8080;
        server_name  localhost;

        # Use HTTP/1.1 for proxy connections (required for keep-alive)
        proxy_http_version 1.1;

        # ===================================================================
        # STATIC FILES - Serve the web frontend
        # ===================================================================
        # Root location "/" serves static HTML/CSS/JS files
        location / {
            # Where static files are stored in the container
            root   /usr/share/nginx/html;
            index  index.html index.htm;
            # SSI (Server Side Includes) for dynamic content
            ssi    on;
            # SPA routing: If file not found, serve index.html
            # This allows React/Vue/Angular routing to work
            try_files $uri $uri/ /index.html;
        }

        # ===================================================================
        # IMAGES - With caching and placeholder
        # ===================================================================
        location /images/ {
            # Cache images for 5 seconds (reduce bandwidth)
            expires 5s;
            root   /usr/share/nginx/html;
            # If image not found, show placeholder
            try_files $uri /images/placeholder.png;
        }

        # ===================================================================
        # ERROR PAGES
        # ===================================================================
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }

        # ===================================================================
        # API REVERSE PROXY - Route to Backend Microservices
        # ===================================================================
        # Each /api/* location routes to a different microservice
        # The trailing slash is important! It strips /api/catalogue from the path
        
        # CATALOGUE SERVICE - Product listings
        # /api/catalogue/products -> http://catalogue:8080/products
        location /api/catalogue/ {
            proxy_pass http://catalogue:8080/;
        }

        # USER SERVICE - Login, registration, sessions
        # /api/user/login -> http://user:8080/login
        location /api/user/ {
            proxy_pass http://user:8080/;
        }

        # CART SERVICE - Shopping cart operations
        # /api/cart/add -> http://cart:8080/add
        location /api/cart/ {
            proxy_pass http://cart:8080/;
        }

        # SHIPPING SERVICE - Shipping cost calculator
        # /api/shipping/cities -> http://shipping:8080/cities
        location /api/shipping/ {
            proxy_pass http://shipping:8080/;
        }

        # PAYMENT SERVICE - Checkout and payment
        # /api/payment/pay -> http://payment:8080/pay
        location /api/payment/ {
            proxy_pass http://payment:8080/;
        }

        # RATINGS SERVICE - Product reviews and ratings
        # Note: Port 80 (PHP) instead of 8080
        # /api/ratings/product/123 -> http://ratings:80/product/123
        location /api/ratings/ {
            proxy_pass http://ratings:80/;
        }

        # ===================================================================
        # NGINX STATUS - For monitoring and health checks
        # ===================================================================
        # Returns Nginx connection statistics
        # Useful for Prometheus scraping
        location /nginx_status {
            stub_status on;
            access_log off;  # Don't log these requests
        }
    }
